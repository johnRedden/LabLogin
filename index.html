<!DOCTYPE html>
<html>
<!--
  * Init Awesome FNL LabLogin App*
-->
<head>
    <title>FNL Lab Login</title>

    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <!-- see http://webdesign.tutsplus.com/tutorials/htmlcss-tutorials/quick-tip-dont-forget-the-viewport-meta-tag -->
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=no">

    <!-- Latest compiled and minified Bootstrap CSS  (bootstrap 4 is out... in alpha) -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <!-- Latest compiled Bootstrap -->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- <script src="filesaver.min.js"></script> -->
   
    <style>
        /* see http://www.quirksmode.org/blog/archives/2014/05/html5_dev_conf.html and http://dev.w3.org/csswg/css-device-adapt/ */
        @-ms-viewport { width: 100vw ; min-zoom: 100% ; zoom: 100% ; }  @viewport { width: 100vw ; min-zoom: 100% zoom: 100% ; }
        @-ms-viewport { user-zoom: fixed ; min-zoom: 100% ; }           @viewport { user-zoom: fixed ; min-zoom: 100% ; }
    </style>


</head>

<body>
<div class="container">

    <h1>FNL Login with Card Reader</h1>

    <input id="logInput" class="form-control" placeholder="Swipe card or type." autofocus></input>
    <br/>
    <blockquote id="logOutput">simple echo for now</blockquote>
	
	<div id="regmenu" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h2>Sign up for <span id="specific-domain">FNL</span> Login</h2>
				</div>
				<div class="modal-body">
					Banner ID: <input type="text" id="bannerID" /><br/><br/>
					First Name: <input type="text" id="firstName" />
					Last Name: <input type="text" id="lastName" />
				</div>
				<div class="modal-footer">
					<span class="btn btn-primary" onclick="verifyRegistration();">Submit</span>
				</div>
			</div>
		</div>
	</div>

    <!-- list group - folks in lab -->
    <ul id="folksInLab" class="list-group">
      <li class="list-group-item">

        <div class="row">
            <div class="col-sm-2">
                <p>ID</p>
            </div>
            <div class="col-sm-4">
                <p>Name</p>
            </div>
            <div class="col-sm-3">
                <p>In</p>
            </div>
            <div class="col-sm-3">
                <p>Out</p>
            </div>
        </div>

      </li>
    </ul>
    <button type="button" class="btn btn-primary" id='report'>CSV Report</button>
</div>


<script>
	// 1. Need a user-domain for SETA_students (one time call only)
	// $.post("http://ens-lablogin-backend.appspot.com/create table user", function(data, status){
	//     console.log(data);
	// });
	// Result of obove one time call: 0c228bdb-eea1-44be-7080-b1682faf26a5
	var seta_students = "0c228bdb-eea1-44be-7080-b1682faf26a5";  //somehow need to hide this.

	// 2. Need a domain for the FNL lab (one time call only)
	// $.post("http://ens-lablogin-backend.appspot.com/get new client", function(data, status){
	//     console.log(data);
	// });
	//Result of obove one time call: 960fb362-35f2-4525-48dc-279795cc5bfb
	var fnl_lab = "960fb362-35f2-4525-48dc-279795cc5bfb";  //somehow need to hide this.

	// 3. Grab the cos Banner UUID from the input Box
	var bannerID = "";
	
    $(document).ready(function(){

        

        $('#logInput').on('keyup',function(e){
            if(e.keyCode == 13){
                bannerID = $(this).val();
				
				// Variables
				var	status=	getState(fnl_lab, seta_students, bannerID);
				
				status.done(function(data)	{
					// Variables
					var	jdata=	JSON.parse(data);
					
					//console.log(data);
					
					switch(jdata.Code)	{
						default:	console.log(data);	break;
						case 404:	openRegisterMenu(bannerID);
						case 0: logout();
					}
				});
            }
        });

    });
	
	function openRegisterMenu(bannerID)	{
		$("#regmenu #bannerID").val(bannerID);
		$("#regmenu #firstName").val("");
		$("#regmenu #lastName").val("");
		$("#regmenu").modal("show");
	}
	
	function getState(domain, userDomain, uuid)	{
		// Variables
		var	promise=	$.post("http://ens-lablogin-backend.appspot.com/select state from record?Domain="+domain+"&User-Domain="+userDomain+"&UUID="+uuid, function(data, status)	{
			//console.log(data);
		});
		
		return promise;
	}

    //utility methods
    function registerLabgoer(arg1,arg2,arg3,arg4){
        //Needs: User-Domain, First, Last, and UUID.
        var promise = $.post('http://ens-lablogin-backend.appspot.com/insert into user?User-Domain='+arg1+'&First='+arg2+'&Last='+arg3+'&UUID='+arg4, function(data, status){
            //console.log(data);
        });
        // returns a promise for this ajax call
        return promise;
    }
    function logLabgoer(arg1,arg2,arg3){
        //Needs: Domain, User-Domain, UUID
        // This is some sort of toggle
        var promise = $.post('http://ens-lablogin-backend.appspot.com/toggle state from record?Domain='+arg1+'&User-Domain='+arg2+'&UUID='+arg3, function(data, status){
           // console.log(data);
        });
        return promise;
    }
	
	function verifyRegistration()	{
		// Variables
		var	bannerID=	$("#bannerID").val();
		var	firstName=	$("#firstName").val();
		var	lastName=	$("#lastName").val();
		var	register;
		
		if(bannerID== "" || firstName== "" || lastName== "" || bannerID.length!= 8)
			return false;
		
		$("#regmenu").modal("hide");
		registerAndLogin(registerLabgoer(seta_students, firstName, lastName, bannerID));
		
	}
	
	function registerAndLogin(registerPromise)	{
		registerPromise.done(function(data)	{
			// Variables
			var	login=	logLabgoer(fnl_lab, seta_students, bannerID);
			
			login.done(function(data2)	{
				// Variables
				var	jdata2=	$.parseJSON(data2);
				
				$("#logOutput").html(jdata2.Results);
			});
		});
	}
	function logout()	{
		
			// Variables
			var	login=	logLabgoer(fnl_lab, seta_students, bannerID);
			
			login.done(function(data2)	{
				// Variables
				var	jdata2=	$.parseJSON(data2);
				
				$("#logOutput").html(jdata2.Results);
			});
		
	}

</script>

</body>
</html>