<!DOCTYPE html>
<html>
<!--
  * Init Awesome FNL LabLogin App*
-->
<head>
    <title>FNL Lab Login</title>

    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <!-- see http://webdesign.tutsplus.com/tutorials/htmlcss-tutorials/quick-tip-dont-forget-the-viewport-meta-tag -->
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=no">

    <!-- Latest compiled and minified Bootstrap CSS  (bootstrap 4 is out... in alpha) -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <!-- Latest compiled Bootstrap -->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- <script src="filesaver.min.js"></script> -->
   
    <style>
        /* see http://www.quirksmode.org/blog/archives/2014/05/html5_dev_conf.html and http://dev.w3.org/csswg/css-device-adapt/ */
        @-ms-viewport { width: 100vw ; min-zoom: 100% ; zoom: 100% ; }  @viewport { width: 100vw ; min-zoom: 100% zoom: 100% ; }
        @-ms-viewport { user-zoom: fixed ; min-zoom: 100% ; }           @viewport { user-zoom: fixed ; min-zoom: 100% ; }
    </style>


</head>

<body>
<div class="container">

    <h1>FNL Login with Card Reader</h1>

    <input id="logInput" class="form-control" placeholder="Swipe card or type." autofocus></input>
    <br/>
    <blockquote id="logOutput">simple echo for now</blockquote>

    <!-- list group - folks in lab -->
    <ul id="folksInLab" class="list-group">
      <li class="list-group-item">

        <div class="row">
            <div class="col-sm-2">
                <p>ID</p>
            </div>
            <div class="col-sm-4">
                <p>Name</p>
            </div>
            <div class="col-sm-3">
                <p>In</p>
            </div>
            <div class="col-sm-3">
                <p>Out</p>
            </div>
        </div>

      </li>
    </ul>
    <button type="button" class="btn btn-primary" id='report'>CSV Report</button>
</div>


<script>
    $(document).ready(function(){

        // 1. Need a user-domain for SETA_students (one time call only)
        // $.post("http://ens-lablogin-backend.appspot.com/create table user", function(data, status){
        //     console.log(data);
        // });
        // Result of obove one time call: 0c228bdb-eea1-44be-7080-b1682faf26a5
        var seta_students = "0c228bdb-eea1-44be-7080-b1682faf26a5";  //somehow need to hide this.

        // 2. Need a domain for the FNL lab (one time call only)
        // $.post("http://ens-lablogin-backend.appspot.com/get new client", function(data, status){
        //     console.log(data);
        // });
        //Result of obove one time call: 960fb362-35f2-4525-48dc-279795cc5bfb
        var fnl_lab = "960fb362-35f2-4525-48dc-279795cc5bfb";  //somehow need to hide this.

        // 3. Grab the cos Banner UUID from the input Box
        var bannerID = "";

        $('#logInput').on('keyup',function(e){
            if(e.keyCode == 13){
                bannerID = $(this).val();

                //4. Need to register a sudent  (only once here)
                var regPromise = registerLabgoer(seta_students,"Joe","Smith",bannerID);

                //5. Need to login this student
                // NOTE: there is database and internet latency here... registered student needs database propagation time.
                // hence the use of a promise.
                regPromise.done(function(){
                    var logPromise = logLabgoer(fnl_lab,seta_students,bannerID);
                    //6 Need to populate the page
                    logPromise.done(function(){
                        // the promise actually holds all the data
                        console.log(logPromise.responseText);
                        var jsonRes = $.parseJSON(logPromise.responseText);
                        $('#logOutput').html(jsonRes.Results);
                    });
                })
                
            }
        });

    });

    //utility methods
    function registerLabgoer(arg1,arg2,arg3,arg4){
        //Needs: User-Domain, First, Last, and UUID.
        var promise = $.post('http://ens-lablogin-backend.appspot.com/insert into user?User-Domain='+arg1+'&First='+arg2+'&Last='+arg3+'&UUID='+arg4, function(data, status){
            //console.log(data);
        });
        // returns a promise for this ajax call
        return promise;
    }
    function logLabgoer(arg1,arg2,arg3){
        //Needs: Domain, User-Domain, UUID
        // This is some sort of toggle
        var promise = $.post('http://ens-lablogin-backend.appspot.com/toggle state from record?Domain='+arg1+'&User-Domain='+arg2+'&UUID='+arg3, function(data, status){
            //console.log(data);
        });
        return promise;
    }


</script>

</body>
</html>